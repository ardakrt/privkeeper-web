"use client"; import { useState, useRef } from"react";
import { Bold, Italic, Link as LinkIcon, Image as ImageIcon, Loader2 } from"lucide-react";
import { createBrowserClient } from"@/lib/supabase/client";
import { toast } from"react-hot-toast"; interface RichNoteEditorProps { value: string; onChange: (value: string) => void; placeholder?: string; minHeight?: string; autoFocus?: boolean; variant?:"boxed" |"seamless"; className?: string;
} export default function RichNoteEditor({ value, onChange, placeholder ="Notunuzu buraya yazın...", minHeight ="h-64", autoFocus = false, variant ="boxed", className ="",
}: RichNoteEditorProps) { const textareaRef = useRef<HTMLTextAreaElement>(null); const fileInputRef = useRef<HTMLInputElement>(null); const [isUploading, setIsUploading] = useState(false); const supabase = createBrowserClient(); // Metin ekleme yardımcısı const insertText = (before: string, after: string ="") => { const textarea = textareaRef.current; if (!textarea) return; const start = textarea.selectionStart; const end = textarea.selectionEnd; const text = textarea.value; const selectedText = text.substring(start, end); const newText = text.substring(0, start) + before + selectedText + after + text.substring(end); onChange(newText); setTimeout(() => { textarea.focus(); textarea.selectionStart = start + before.length; textarea.selectionEnd = end + before.length; }, 0); }; // Resim yükleme const handleImageUpload = async (e: React.ChangeEvent<HTMLInputElement>) => { const file = e.target.files?.[0]; if (!file) return; if (file.size > 5 * 1024 * 1024) { toast.error("Resim boyutu 5MB'dan küçük olmalı"); return; } setIsUploading(true); try { const { data: { user } } = await supabase.auth.getUser(); if (!user) throw new Error("Kullanıcı bulunamadı"); const fileExt = file.name.split(".").pop(); const fileName = `${user.id}/${Date.now()}.${fileExt}`; const { error: uploadError } = await supabase.storage .from("note_attachments") .upload(fileName, file); if (uploadError) throw uploadError; const { data: publicUrlData } = supabase.storage .from("note_attachments") .getPublicUrl(fileName); // Markdown resim formatı: ![alt](url) const markdownImage = `\n![${file.name}](${publicUrlData.publicUrl})\n`; // insertText fonksiyonunu kullanmak yerine doğrudan state güncelleyelim (Garanti olsun) const textarea = textareaRef.current; if (textarea) { const start = textarea.selectionStart; const end = textarea.selectionEnd; const text = textarea.value; const newText = text.substring(0, start) + markdownImage + text.substring(end); onChange(newText); } else { // Fallback: Sona ekle onChange(value + markdownImage); } toast.success("Resim eklendi"); } catch (error) { console.error("Upload error:", error); toast.error("Resim yüklenemedi"); } finally { setIsUploading(false); if (fileInputRef.current) fileInputRef.current.value =""; } }; const isSeamless = variant ==="seamless"; return ( <div className={`w-full flex flex-col ${isSeamless ?"" :"border border-white/10 rounded-xl overflow-hidden bg-zinc-50 bg-zinc-900/50 focus-within:ring-2 focus-within:ring-emerald-500/20 focus-within:border-emerald-500"} transition-all ${className}`}> {/* Toolbar */} <div className={`flex items-center gap-1 p-2 ${isSeamless ?"border-b border-white/5 bg-transparent mb-4" :"border-b border-white/10 bg-white/5"}`}> <button type="button" onClick={() => insertText("**","**")} className={`p-2 rounded-lg text-zinc-400 hover:text-zinc-900 hover:text-white transition-colors ${isSeamless ?"hover:bg-zinc-100 hover:bg-white/10" :"hover:bg-zinc-100 hover:bg-white/10"}`} title="Kalın" > <Bold className="w-4 h-4" /> </button> <button type="button" onClick={() => insertText("*","*")} className="p-2 rounded-lg hover:bg-zinc-100 hover:bg-white/10 text-zinc-400 hover:text-zinc-900 hover:text-white transition-colors" title="İtalik" > <Italic className="w-4 h-4" /> </button> <div className="w-px h-4 bg-zinc-300 bg-white/10 mx-1" /> <button type="button" onClick={() => insertText("[","](url)")} className="p-2 rounded-lg hover:bg-zinc-100 hover:bg-white/10 text-zinc-400 hover:text-zinc-900 hover:text-white transition-colors" title="Link" > <LinkIcon className="w-4 h-4" /> </button> <button type="button" onClick={() => fileInputRef.current?.click()} disabled={isUploading} className="p-2 rounded-lg hover:bg-zinc-100 hover:bg-white/10 text-zinc-400 hover:text-zinc-900 hover:text-white transition-colors relative" title="Resim Ekle" > {isUploading ? ( <Loader2 className="w-4 h-4 animate-spin" /> ) : ( <ImageIcon className="w-4 h-4" /> )} </button> <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleImageUpload} /> </div> {/* Textarea */} <textarea ref={textareaRef} value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} className={`w-full p-4 bg-transparent resize-none focus:outline-none text-white placeholder:text-zinc-400 placeholder:text-zinc-600 ${minHeight} ${isSeamless ?"p-0" :""}`} autoFocus={autoFocus} /> </div> );
}