"use client"; import { useState, useMemo } from"react";
import { motion, AnimatePresence } from"framer-motion";
import { Subscription, enrichSubscription } from"@/types/finance";
import SubscriptionCard from"@/components/finance/SubscriptionCard";
import AddFinanceModal from"@/components/finance/AddFinanceModal";
import AddLoanModal from"@/components/finance/AddLoanModal";
import { CreditCard, AlertCircle } from"lucide-react";
import { createBrowserClient } from"@/lib/supabase/client";
import { useRouter } from"next/navigation"; type TabType ="subscriptions" |"loans"; interface SubscriptionsClientProps { initialSubscriptions: Subscription[];
} export default function SubscriptionsClient({ initialSubscriptions }: SubscriptionsClientProps) { const [activeTab, setActiveTab] = useState<TabType>("subscriptions"); const [searchQuery, setSearchQuery] = useState(""); const [currentView, setCurrentView] = useState<"list" |"create">("list"); // Initialize with server-provided data const [subscriptions, setSubscriptions] = useState<Subscription[]>(initialSubscriptions); const [isLoading, setIsLoading] = useState(false); // Data is already here const [editingItem, setEditingItem] = useState<any | null>(null); const [deletingItem, setDeletingItem] = useState<any | null>(null); const supabase = createBrowserClient(); const router = useRouter(); // Filter data based on active tab const filteredData = useMemo(() => { const filtered = subscriptions.filter((item) => activeTab ==="subscriptions" ? item.type ==="subscription" : item.type ==="loan" ); return filtered.map(enrichSubscription); }, [activeTab, subscriptions]); // Search filter const searchFilteredData = useMemo(() => { if (!searchQuery.trim()) return filteredData; const query = searchQuery.toLowerCase(); return filteredData.filter((item) => item.name.toLowerCase().includes(query) || (item.linked_card_details && item.linked_card_details.toLowerCase().includes(query)) ); }, [filteredData, searchQuery]); const getAddButtonText = () => { return activeTab ==="subscriptions" ?"Yeni Abonelik Ekle" :"Yeni Kredi Ekle"; }; const loadSubscriptions = async () => { const { data: { user } } = await supabase.auth.getUser(); if (!user) { router.push("/login"); return; } const { data, error } = await supabase .from("subscriptions") .select("*") .eq("user_id", user.id) .order("created_at", { ascending: false }); if (error) { console.error("Error loading subscriptions:", error); } else if (data) { setSubscriptions(data as Subscription[]); } }; const handleAddNew = () => { setCurrentView("create"); const scrollContainer = document.querySelector('.flex-1.overflow-y-auto'); if (scrollContainer) { scrollContainer.scrollTo({ top: 0, behavior: 'smooth' }); } }; const handleBackToList = () => { setCurrentView("list"); setEditingItem(null); }; const handleSuccess = async () => { await loadSubscriptions(); setCurrentView("list"); setEditingItem(null); }; const openDeleteModal = (item: any) => { setDeletingItem(item); }; const confirmDelete = async () => { if (!deletingItem) return; try { const { error } = await supabase .from("subscriptions") .delete() .eq("id", deletingItem.id); if (error) throw error; setDeletingItem(null); await loadSubscriptions(); } catch (error: any) { console.error("Delete Error:", error); alert("Silme işlemi başarısız:" + error.message); } }; const handleEdit = (item: any) => { setEditingItem(item); setCurrentView("create"); const scrollContainer = document.querySelector('.flex-1.overflow-y-auto'); if (scrollContainer) { scrollContainer.scrollTo({ top: 0, behavior: 'smooth' }); } }; return ( <div className="w-full h-full px-0 sm:px-2 py-0 sm:py-2 md:py-4 lg:pt-6"> <div className="w-full h-full transition-all duration-500 ease-in-out"> <div className="w-full h-full flex flex-col border-0 sm:border rounded-none sm:rounded-2xl md:rounded-3xl border-white/10 border-white/10 border-gray-200 bg-transparent sm:bg-black/20 bg-transparent sm:dark:bg-black/20 bg-transparent sm:bg-white/90 sm:backdrop-blur-sm overflow-hidden shadow-none sm:shadow-xl"> <div className="p-3 sm:p-4 md:p-6 lg:p-8 space-y-3 sm:space-y-4 md:space-y-6 flex-shrink-0"> <div className="flex flex-col gap-3 sm:gap-0 sm:relative sm:flex-row items-stretch sm:items-center justify-center"> <h1 className="sm:absolute sm:left-0 text-xl sm:text-2xl font-bold text-white text-gray-900"> Harcama Takibi </h1> <div className="flex justify-center w-full sm:max-w-md"> <div className="relative w-full group"> <div className="absolute inset-y-0 left-0 pl-3 sm:pl-4 flex items-center pointer-events-none z-10"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4 sm:w-5 sm:h-5 text-zinc-400 group-focus-within:text-emerald-500 transition-colors duration-300" > <circle cx="11" cy="11" r="8" /> <path d="m21 21-4.3-4.3" /> </svg> </div> <input type="search" placeholder="Ara..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full h-10 sm:h-12 bg-zinc-100 hover:bg-zinc-200/50 bg-zinc-900/40 hover:bg-zinc-900/60 backdrop-blur-xl border border-transparent border-white/10 focus:bg-white focus:bg-zinc-900/80 focus:border-emerald-500/30 focus:ring-2 sm:focus:ring-4 focus:ring-emerald-500/10 rounded-lg sm:rounded-2xl pl-10 sm:pl-11 pr-3 sm:pr-4 text-xs sm:text-sm text-zinc-200 placeholder:text-zinc-400 placeholder:text-zinc-500 transition-all duration-300 ease-out outline-none shadow-sm hover:shadow-md" /> </div> </div> {currentView === 'create' ? ( <button onClick={handleBackToList} className="sm:absolute sm:right-0 w-full sm:w-auto bg-white/5 bg-white/5 bg-gray-100 text-white text-gray-900 px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg sm:rounded-xl text-xs sm:text-sm font-medium hover:bg-white/10 hover:bg-white/10 hover:bg-gray-200 border border-white/10 border-white/10 border-gray-300 hover:border-white/20 hover:border-white/20 hover:border-zinc-400 transition-all flex items-center justify-center gap-2" > <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}> <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /> </svg> Listeye Dön </button> ) : ( <button onClick={handleAddNew} className="sm:absolute sm:right-0 w-full sm:w-auto bg-white bg-gray-900 text-black text-black text-gray-900 hover:bg-zinc-200 hover:bg-zinc-200 hover:bg-black px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg sm:rounded-xl text-xs sm:text-sm font-semibold transition-colors flex items-center justify-center gap-2 shadow-lg" > <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}> <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /> </svg> <span className="hidden sm:inline">{getAddButtonText()}</span> <span className="sm:hidden">Ekle</span> </button> )} </div> <div className="flex justify-start overflow-x-auto scrollbar-none"> <div className="bg-white/5 bg-white/5 bg-gray-100 border border-white/10 border-white/10 border-gray-200 rounded-full p-0.5 sm:p-1 flex items-center gap-0.5 sm:gap-1 min-w-max"> <button onClick={() => setActiveTab("subscriptions")} className={`px-3 sm:px-4 py-1 sm:py-1.5 rounded-full text-xs sm:text-sm transition-all whitespace-nowrap ${activeTab ==="subscriptions" ?"bg-zinc-800 bg-zinc-800 bg-gray-900 text-white" :"text-white/70 text-white/70 text-gray-600 hover:text-white hover:text-white hover:text-gray-900 hover:bg-white/10 hover:bg-white/10 hover:bg-gray-200" }`} > Abonelikler </button> <button onClick={() => setActiveTab("loans")} className={`px-3 sm:px-4 py-1 sm:py-1.5 rounded-full text-xs sm:text-sm transition-all whitespace-nowrap ${activeTab ==="loans" ?"bg-zinc-800 bg-zinc-800 bg-gray-900 text-white" :"text-white/70 text-white/70 text-gray-600 hover:text-white hover:text-white hover:text-gray-900 hover:bg-white/10 hover:bg-white/10 hover:bg-gray-200" }`} > Krediler </button> </div> </div> </div> <div className="flex-1 p-3 sm:p-4 md:p-6 lg:p-8 overflow-y-auto custom-scrollbar"> <AnimatePresence mode="wait"> {currentView ==="create" ? ( <motion.div key="create" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} transition={{ duration: 0.2 }} > {activeTab ==="subscriptions" ? ( <AddFinanceModal onClose={handleBackToList} onSuccess={handleSuccess} editData={editingItem} /> ) : ( <AddLoanModal onClose={handleBackToList} onSuccess={handleSuccess} editData={editingItem} /> )} </motion.div> ) : isLoading ? ( <motion.div key="loading" initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex items-center justify-center py-16" > <div className="text-zinc-400">Yükleniyor...</div> </motion.div> ) : searchFilteredData.length === 0 ? ( <motion.div key="empty" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} transition={{ duration: 0.2 }} className="flex flex-col items-center justify-center py-16 px-4" > <div className="bg-zinc-800/50 bg-zinc-800/50 bg-gray-100 w-20 h-20 rounded-full flex items-center justify-center mb-6"> <CreditCard className="w-10 h-10 text-zinc-600 text-gray-400" /> </div> <h3 className="text-white text-gray-900 font-semibold text-lg mb-2"> {searchQuery.trim() ?"Sonuç bulunamadı" : activeTab ==="subscriptions" ?"Henüz abonelik eklenmedi" :"Henüz kredi eklenmedi"} </h3> <p className="text-zinc-500 text-gray-600 text-sm text-center max-w-md mb-6"> {searchQuery.trim() ?"Arama kriterlerinize uygun bir sonuç bulunamadı." : activeTab ==="subscriptions" ?"Aylık aboneliklerinizi buradan takip edin." :"Kredi ve taksit ödemelerinizi buradan takip edin."} </p> {!searchQuery.trim() && ( <button onClick={handleAddNew} className="bg-white bg-gray-900 text-black text-black text-gray-900 hover:bg-zinc-200 hover:bg-zinc-200 hover:bg-black px-6 py-3 rounded-xl text-sm font-semibold transition-colors flex items-center gap-2 shadow-lg" > <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}> <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /> </svg> {getAddButtonText()} </button> )} </motion.div> ) : ( <motion.div key="list" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} transition={{ duration: 0.2 }} className="grid grid-cols-1 lg:grid-cols-2 gap-4" > {searchFilteredData.map((item) => ( <SubscriptionCard key={item.id} item={item} onEdit={handleEdit} onDelete={() => openDeleteModal(item)} /> ))} </motion.div> )} </AnimatePresence> </div> </div> </div> <AnimatePresence> {deletingItem && ( <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} className="fixed inset-0 z-50 bg-black/60 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setDeletingItem(null)} > <motion.div initial={{ scale: 0.9, y: 20 }} animate={{ scale: 1, y: 0 }} exit={{ scale: 0.9, y: 20 }} className="bg-[#121212] border border-red-200 border-red-500/20 rounded-3xl p-8 w-full max-w-md shadow-2xl relative" onClick={e => e.stopPropagation()} > <div className="text-center"> <div className="mx-auto w-16 h-16 rounded-2xl bg-red-100 bg-red-500/20 border-2 border-red-200 border-red-500/30 flex items-center justify-center mb-4"> <AlertCircle className="w-8 h-8 text-red-500 text-red-400" /> </div> <h2 className="text-2xl font-bold text-white mb-2"> {deletingItem.type === 'subscription' ? 'Aboneliği Sil' : 'Krediyi Sil'} </h2> <p className="text-zinc-400 mb-2"> Bu {deletingItem.type === 'subscription' ? 'aboneliği' : 'krediyi'} silmek istediğinden emin misin? </p> <div className="bg-zinc-50 bg-zinc-900/50 border border-white/5 rounded-xl p-4 mb-6 text-left"> <h3 className="text-white font-semibold text-sm mb-1">{deletingItem.name}</h3> <p className="text-zinc-500 text-xs"> {deletingItem.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ₺ / {deletingItem.billing_cycle === 'monthly' ? 'Aylık' : 'Yıllık'} </p> </div> <div className="flex gap-3"> <button onClick={() => setDeletingItem(null)} className="flex-1 bg-zinc-200 bg-zinc-800 hover:bg-zinc-300 hover:bg-zinc-700 text-white font-bold py-3.5 rounded-xl transition-all active:scale-95" > İptal </button> <button onClick={confirmDelete} className="flex-1 bg-red-500 hover:bg-red-600 hover:bg-red-400 text-white font-bold py-3.5 rounded-xl transition-all shadow-lg shadow-red-500/20 hover:shadow-red-500/40 active:scale-95" > Evet, Sil </button> </div> </div> </motion.div> </motion.div> )} </AnimatePresence> </div> );
}
