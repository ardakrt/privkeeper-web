'use client'; import { useState, useEffect, useRef, useMemo, useCallback } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { createBrowserClient } from '@/lib/supabase/client';
import CardsPageManager from '@/components/CardsPageManager';
import IbansPageManager from '@/components/IbansPageManager';
import AccountsPageManager from '@/components/AccountsPageManager';
import { useRouter } from 'next/navigation';
import { useModalStore } from '@/lib/store/useModalStore'; interface WalletClientProps { initialCards: any[]; initialIbans: any[]; initialAccounts: any[];
} export default function WalletClient({ initialCards, initialIbans, initialAccounts }: WalletClientProps) { const [cards, setCards] = useState<any[]>(initialCards); const [ibans, setIbans] = useState<any[]>(initialIbans); const [accounts, setAccounts] = useState<any[]>(initialAccounts); const [activeTab, setActiveTab] = useState('cards'); const [searchQuery, setSearchQuery] = useState(''); const [isLoading, setIsLoading] = useState(false); // Data is passed from server const cardsRef = useRef<any>(null); const ibansRef = useRef<any>(null); const accountsRef = useRef<any>(null); const supabase = createBrowserClient(); const router = useRouter(); const isAddCardModalOpen = useModalStore((state) => state.isAddCardModalOpen); const openAddCardModal = useModalStore((state) => state.openAddCardModal); const isAddIbanModalOpen = useModalStore((state) => state.isAddIbanModalOpen); const openAddIbanModal = useModalStore((state) => state.openAddIbanModal); const [currentView, setCurrentView] = useState<"list" |"create">("list"); const handleViewChange = (view:"list" |"create") => { setCurrentView(view); }; // Reset view when tab changes useEffect(() => { setCurrentView("list"); }, [activeTab]); // Switch to relevant tab if global modal is opened useEffect(() => { if (isAddCardModalOpen) { setActiveTab('cards'); } }, [isAddCardModalOpen]); useEffect(() => { if (isAddIbanModalOpen) { setActiveTab('ibans'); } }, [isAddIbanModalOpen]); // Refetch function for manual refreshes (after add/edit/delete) const loadData = useCallback(async () => { const { data: { user }, } = await supabase.auth.getUser(); if (!user) { router.push('/login'); return; } // We fetch all data again to keep everything in sync, // or we could just fetch the active tab. // fetching active tab is more efficient for client-side refresh. if (activeTab === 'cards') { const { data: cardsData } = await supabase.from('cards').select('*').order('created_at', { ascending: false }); if (cardsData) setCards(cardsData); } else if (activeTab === 'ibans') { const { data: ibansData } = await supabase.from('ibans').select('*').order('created_at', { ascending: false }); if (ibansData) setIbans(ibansData); } else if (activeTab === 'accounts') { const { data: accountsData } = await supabase.from('accounts').select('*'); if (accountsData) setAccounts(accountsData); } }, [activeTab, router, supabase]); // No initial useEffect for loadData, as we use props. const refreshData = useCallback(() => { loadData(); }, [loadData]); const normalizedQuery = searchQuery.trim().toLowerCase(); const filteredCards = useMemo(() => { if (!normalizedQuery) return cards; return cards.filter((card) => { const label = (card.label ?? '').toLowerCase(); const holder = (card.holder_name_enc ?? '').toLowerCase(); const lastFour = (card.last_four ?? '').toString(); return ( label.includes(normalizedQuery) || holder.includes(normalizedQuery) || lastFour.includes(normalizedQuery) ); }); }, [cards, normalizedQuery]); const filteredIbans = useMemo(() => { if (!normalizedQuery) return ibans; return ibans.filter((iban) => { const label = (iban.label ?? '').toLowerCase(); const number = (iban.iban ?? '').toLowerCase(); return label.includes(normalizedQuery) || number.includes(normalizedQuery); }); }, [ibans, normalizedQuery]); const filteredAccounts = useMemo(() => { if (!normalizedQuery) return accounts; return accounts.filter((account) => { const service = (account.service_name ?? account.service ?? '').toLowerCase(); const username = (account.username ?? account.username_enc ?? '').toLowerCase(); return service.includes(normalizedQuery) || username.includes(normalizedQuery); }); }, [accounts, normalizedQuery]); const getAddButtonText = () => { switch (activeTab) { case 'cards': return 'Yeni Kart Ekle'; case 'ibans': return 'Yeni IBAN Ekle'; case 'accounts': return 'Yeni Hesap Ekle'; default: return 'Yeni Ekle'; } }; const handleAddNew = () => { if (activeTab === 'cards') { openAddCardModal(); } else if (activeTab === 'ibans') { openAddIbanModal(); } else if (activeTab === 'accounts' && accountsRef.current?.triggerCreate) { accountsRef.current.triggerCreate(); } }; return ( <div className="w-full h-full px-0 sm:px-2 py-0 sm:py-2 md:py-4 lg:pt-6"> <div className={`w-full h-full transition-all duration-500 ease-in-out`}> <div className="w-full h-full flex flex-col border-0 sm:border rounded-none sm:rounded-2xl md:rounded-3xl border-white/10 border-white/10 border-gray-300 bg-black/20 bg-black/20 bg-white/80 backdrop-blur-xl overflow-hidden shadow-xl shadow-zinc-200/50"> <div className="p-3 sm:p-4 md:p-6 lg:p-8 space-y-3 sm:space-y-4 md:space-y-6 flex-shrink-0"> {/* Header Section - Top Row */} <div className="flex flex-col gap-3 sm:gap-0 sm:relative sm:flex-row items-stretch sm:items-center justify-center"> {/* Title - Mobile: Full width, Desktop: Absolute Left */} <h1 className="sm:absolute sm:left-0 text-xl sm:text-2xl font-bold text-white text-gray-900">Cüzdanım</h1> {/* Search Bar - Kart veya IBAN'larda ara */} <div className="flex justify-center w-full sm:max-w-md"> <div className="relative w-full group"> {/* İKON (z-10 ile öne alındı) */} <div className="absolute inset-y-0 left-0 pl-3 sm:pl-4 flex items-center pointer-events-none z-10"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4 sm:w-5 sm:h-5 text-zinc-400 text-gray-500 group-focus-within:text-emerald-500 transition-colors duration-300" > <circle cx="11" cy="11" r="8" /> <path d="m21 21-4.3-4.3" /> </svg> </div> {/* INPUT */} <input type="search" placeholder="Ara..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full h-10 sm:h-12 bg-zinc-100/10 hover:bg-zinc-100/20 bg-zinc-900/40 hover:bg-zinc-900/60 bg-gray-100 hover:bg-gray-200/70 backdrop-blur-xl border border-transparent border-white/10 border-gray-200 focus:bg-white/10 focus:bg-zinc-900/80 focus:bg-white focus:border-emerald-500/30 focus:ring-2 sm:focus:ring-4 focus:ring-emerald-500/10 rounded-lg sm:rounded-2xl pl-10 sm:pl-11 pr-3 sm:pr-4 text-xs sm:text-sm text-zinc-200 text-gray-900 placeholder:text-zinc-400 placeholder:text-zinc-500 placeholder:text-zinc-500 transition-all duration-300 ease-out outline-none shadow-sm hover:shadow-md" /> </div> </div> {/* Action Button - Mobile: Full width, Desktop: Absolute Right */} {currentView === 'create' ? ( <button onClick={() => { if (activeTab === 'cards') useModalStore.getState().closeAddCardModal(); else if (activeTab === 'ibans') useModalStore.getState().closeAddIbanModal(); else if (activeTab === 'accounts') accountsRef.current?.triggerList(); }} className="sm:absolute sm:right-0 w-full sm:w-auto bg-white/5 bg-white/5 bg-gray-100 text-white text-gray-900 px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg sm:rounded-xl text-xs sm:text-sm font-medium hover:bg-white/10 hover:bg-white/10 hover:bg-gray-200 border border-white/10 border-white/10 border-gray-300 hover:border-white/20 hover:border-white/20 hover:border-zinc-400 transition-all flex items-center justify-center gap-2" > <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}> <path strokeLinecap="round" strokeLinejoin="round" d="M15 19l-7-7 7-7" /> </svg> Listeye Dön </button> ) : ( <button onClick={handleAddNew} className="sm:absolute sm:right-0 w-full sm:w-auto bg-white bg-gray-900 text-black text-black text-gray-900 hover:bg-zinc-200 hover:bg-zinc-200 hover:bg-black px-4 sm:px-5 py-2 sm:py-2.5 rounded-lg sm:rounded-xl text-xs sm:text-sm font-semibold transition-colors flex items-center justify-center gap-2 shadow-lg" > <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2.5}> <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" /> </svg> <span className="hidden sm:inline">{getAddButtonText()}</span> <span className="sm:hidden">Ekle</span> </button> )} </div> {/* Tabs Row */} <div className="flex justify-start overflow-x-auto scrollbar-none"> <div className="bg-white/5 bg-white/5 bg-gray-100 border border-white/10 border-white/10 border-gray-200 rounded-full p-0.5 sm:p-1 flex items-center gap-0.5 sm:gap-1 min-w-max"> <button onClick={() => setActiveTab('cards')} className={`px-3 sm:px-4 py-1 sm:py-1.5 rounded-full text-xs sm:text-sm transition-all whitespace-nowrap ${activeTab === 'cards' ? 'bg-zinc-800 bg-zinc-800 bg-white text-white text-gray-900 shadow-sm' : 'text-white/70 text-white/70 text-gray-500 hover:text-white hover:text-white hover:text-gray-900 hover:bg-white/10 hover:bg-white/10 hover:bg-gray-200' }`} > Kartlar </button> <button onClick={() => setActiveTab('ibans')} className={`px-3 sm:px-4 py-1 sm:py-1.5 rounded-full text-xs sm:text-sm transition-all whitespace-nowrap ${activeTab === 'ibans' ? 'bg-zinc-800 bg-zinc-800 bg-white text-white text-gray-900 shadow-sm' : 'text-white/70 text-white/70 text-gray-500 hover:text-white hover:text-white hover:text-gray-900 hover:bg-white/10 hover:bg-white/10 hover:bg-gray-200' }`} > IBAN'lar </button> <button onClick={() => setActiveTab('accounts')} className={`px-3 sm:px-4 py-1 sm:py-1.5 rounded-full text-xs sm:text-sm transition-all whitespace-nowrap ${activeTab === 'accounts' ? 'bg-zinc-800 bg-zinc-800 bg-white text-white text-gray-900 shadow-sm' : 'text-white/70 text-white/70 text-gray-500 hover:text-white hover:text-white hover:text-gray-900 hover:bg-white/10 hover:bg-white/10 hover:bg-gray-200' }`} > Hesaplar </button> </div> </div> </div> <div className="flex-1 p-3 sm:p-4 md:p-6 lg:p-8 overflow-y-auto custom-scrollbar"> <AnimatePresence mode="wait"> {activeTab === 'cards' && ( <motion.div key="cards" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} transition={{ duration: 0.2 }} > <CardsPageManager ref={cardsRef} cards={filteredCards} onRefresh={refreshData} onViewChange={handleViewChange} /> </motion.div> )} {activeTab === 'ibans' && ( <motion.div key="ibans" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} transition={{ duration: 0.2 }} > <IbansPageManager ref={ibansRef} ibans={filteredIbans} onRefresh={refreshData} onViewChange={handleViewChange} /> </motion.div> )} {activeTab === 'accounts' && ( <motion.div key="accounts" initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: -10 }} transition={{ duration: 0.2 }} > <AccountsPageManager ref={accountsRef} accounts={filteredAccounts} onRefresh={refreshData} onViewChange={handleViewChange} /> </motion.div> )} </AnimatePresence> </div> </div> </div> </div> );
}
